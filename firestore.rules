rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function: Check if user is authenticated
    function isSignedIn() {
      return request.auth != null;
    }

    // Helper function: Check if user is owner
    function isOwner(uid) {
      return isSignedIn() && request.auth.uid == uid;
    }

    // ✅ Users collection rules
    match /users/{userId} {
      // Allow read if user is the owner
      allow read: if isOwner(userId);

      // Allow create only if:
      // 1. User is authenticated AND
      // 2. User is creating their own document AND
      // 3. All required fields are present (codeHash, mandalaGraphicURL 포함)
      // 4. uid matches the document ID
      allow create: if isSignedIn()
                    && request.auth.uid == userId
                    && request.resource.data.keys().hasAll(['uid', 'nickname', 'codeHash', 'mandalaGraphicURL', 'createdAt', 'updatedAt'])
                    && request.resource.data.uid == userId
                    && request.resource.data.nickname is string
                    && request.resource.data.codeHash is string
                    && request.resource.data.mandalaGraphicURL is string
                    && request.resource.data.createdAt is string
                    && request.resource.data.updatedAt is string;

      // Allow update only if:
      // 1. User is the owner AND
      // 2. uid field is not changed AND
      // 3. createdAt is not changed
      allow update: if isOwner(userId)
                    && request.resource.data.uid == resource.data.uid
                    && request.resource.data.createdAt == resource.data.createdAt;

      // Allow delete if user is the owner
      allow delete: if isOwner(userId);

      // ✅✅✅ PLACES SUBCOLLECTION RULES ✅✅✅
      match /places/{placeId} {
        // Allow read if user is the owner of the parent user document
        allow read: if isOwner(userId);

        // Allow create if:
        // 1. User is authenticated AND
        // 2. User is the owner of the parent user document AND
        // 3. Required fields are present
        allow create: if isOwner(userId)
                      && request.resource.data.keys().hasAll(['realPlaceName', 'latitude', 'longitude', 'intimacyScore', 'emotionKeywords', 'createdAt', 'updatedAt'])
                      && request.resource.data.realPlaceName is string
                      && request.resource.data.latitude is number
                      && request.resource.data.longitude is number
                      && request.resource.data.intimacyScore is number
                      && request.resource.data.intimacyScore >= 0
                      && request.resource.data.intimacyScore <= 100
                      && request.resource.data.emotionKeywords is list
                      && request.resource.data.emotionKeywords.size() >= 1
                      && request.resource.data.emotionKeywords.size() <= 3;

        // Allow update if user is the owner
        allow update: if isOwner(userId)
                      && request.resource.data.createdAt == resource.data.createdAt;

        // Allow delete if user is the owner
        allow delete: if isOwner(userId);
      }
    }

    // ✅ Nicknames collection rules
    match /nicknames/{nickname} {
      // Anyone can read nicknames (for duplicate checking)
      allow read: if true;

      // Allow create only if:
      // 1. User is authenticated AND
      // 2. All required fields are present AND
      // 3. uid matches the authenticated user
      allow create: if isSignedIn()
                    && request.resource.data.keys().hasAll(['uid', 'createdAt'])
                    && request.resource.data.uid == request.auth.uid
                    && request.resource.data.createdAt is string;

      // Prevent updates to nickname documents
      allow update: if false;

      // Allow delete only if the user owns this nickname
      allow delete: if isSignedIn()
                    && resource.data.uid == request.auth.uid;
    }

    // ✅ Mandalas collection rules (for future use)
    match /mandalas/{mandalaId} {
      allow read: if true; // Public read
      allow create, update, delete: if isSignedIn()
                                     && request.resource.data.userId == request.auth.uid;
    }

    // Deny all other collections by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
